<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Star Wars CA</title>
</head>

<style>

html {
  width: 100%;
  height: 100%;
}

body {
  background: #000;
  display: flex;
  width: 100%;
  height: 100%;
  margin: 0;
  justify-content: center;
  align-items: center;
}

#canvas {
  image-rendering: pixelated;
}

</style>

<body>
  <canvas id="canvas"></canvas> 
</body>

<script src="https://nxrix.github.io/pixel-8/src/pixel8.js"></script>
<script>

canvas.width = canvas.height = 256;
const w = canvas.width;
const h = canvas.height;
const w2 = canvas.width/2;
const h2 = canvas.height/2;
const wxh = w*h;
const px8 = new Pixel8(w,h);
const ctx = canvas.getContext("2d");
const img = ctx.createImageData(w,h);
const img_data = img.data;

function resize() {
  const scale = Math.floor(Math.min(window.innerWidth/w,window.innerHeight/h));
  const s = Math.max(1, scale);
  canvas.style.width = w*s+"px";
  canvas.style.height = h*s+"px";
}
resize();
window.addEventListener("resize", resize);

function mulberry32(seed) {
  return function() {
    seed |= 0; seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  }
}

const lerp = (a,b,t) => {
  return Math.round(a+(b-a)*t);
}

const grad = (v,p) => {
  v = Math.min(1,Math.max(0,v));
  const i = Math.min(Math.floor(v*(p.length-1)),p.length-2);
  const t = v*(p.length-1)-i;
  const c1 = Pixel8.palette[p[i  ]];
  const c2 = Pixel8.palette[p[i+1]];
  return [lerp(c1[0],c2[0],t),lerp(c1[1],c2[1],t),lerp(c1[2],c2[2],t)];
}

const grad0 = (v,p) => {
  v = Math.min(1,Math.max(0,v));
  const i = Math.min(Math.floor(v*(p.length-1)),p.length-2);
  const t = v*(p.length-1)-i;
  const c1 = p[i  ];
  const c2 = p[i+1];
  return [lerp(c1[0],c2[0],t),lerp(c1[1],c2[1],t),lerp(c1[2],c2[2],t)];
}

function i(x,y) {
  //return (x<0||y<0||x>=w||y>=h)?0:x+y*w;
  return ((x+w)%w)+((y+h)%h)*w;
}

const p = [0,20,21,22,23,19,18,17,13,14,15,11,10,6,7,31,27,26,25,24,1,2,3];
const nx = [...atob("AAAMrqlJEiqioAAA")].flatMap(c=>c.charCodeAt(0).toString(2).padStart(8,"0").split("").map(Number));
let buf0 = new Uint8Array(wxh);
let buf1 = new Uint8Array(wxh);

buf0[(h2|0)-4+(h2|0)*h] = 3;
buf0[(h2|0)-3+(h2|0)*h] = 3;

buf0[(h2|0)+3+(h2|0)*h] = 3;
buf0[(h2|0)+4+(h2|0)*h] = 3;

const states = 4;
const b = [2];
const s = [3,4,5];

let t = 0;
const update = () => {
  //px8.cls();
  for (let y=0;y<h;y++) {
    for (let x=0;x<w;x++) {
      let n = 0;
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          if (!dx&&!dy) continue;
          if (buf0[i(x+dx,y+dy)] === states-1) n++;
        }
      }
      let idx = i(x,y);
      let c = buf0[idx];
      if (c === states - 1) {
        buf1[idx] = s.includes(n) ? states - 1 : states - 2;
      } else if (c === 0) {
        buf1[idx] = b.includes(n) ? states - 1 : 0;
        } else {
        buf1[idx] = c - 1;
        }
      }
    }
  [buf0,buf1] = [buf1,buf0];
  for (let y=0;y<h;y++) {
    for (let x=0;x<w;x++) {
      const c = buf0[x+y*h];
      //px8.pset(x,y,c>0?19+c:Math.max(px8.pget(x,y)-1,0));
      px8.buffer[x+y*w] = c>0?252+c:Math.max(px8.pget(x,y)-1,0);
    }
  }
  for (let x=0;x<w;x++) {
    px8.buffer[x+(w-1)*w] = x;
  }
  for (let x=0;x<19;x++) {
    for (let y=0;y<5;y++) {
      px8.buffer[x+1+(y+w-7)*w] = nx[x+y*19]*255;
    }
  }
  for (let i = 0; i < wxh; i++) {
    //const c = Pixel8.palette[p[Math.floor(px8.buffer[i])%23]];
    const c = grad(px8.buffer[i]/255,p);
    //const c = grad0(px8.buffer[i]/255,Pixel8.palette);
    const index = i * 4;
    img_data[index    ] = c[0];
    img_data[index + 1] = c[1];
    img_data[index + 2] = c[2];
    img_data[index + 3] = 255;
  }
  ctx.putImageData(img,0,0);
  t++;
  requestAnimationFrame(update);
}

update();

</script>

</html>